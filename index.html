<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Generador de Links Multiagente</title>
  <style>
  body {
    font-family: Arial, sans-serif;
    margin: 0;
    padding: 0;
    background-color: #0a1128; /* Fondo azul oscuro */
    color: #ffffff; /* Texto blanco */
  }

  header {
    background-color: #1c2541; /* Azul más claro */
    padding: 20px;
    text-align: center;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
  }

  .titulo-principal {
    font-size: 2.5rem;
    font-weight: bold;
    color: #25d366; /* Verde de WhatsApp */
    margin: 0;
  }

  h1, h2 {
    text-align: center;
    color: #ffffff;
  }

  form {
    max-width: 600px;
    margin: 20px auto;
    padding: 20px;
    background-color: #1c2541; /* Azul más claro para el fondo del formulario */
    border-radius: 8px;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    text-align: center; /* Centra los botones dentro del formulario */
  }

  label {
    display: block;
    margin-top: 10px;
    font-weight: bold;
    color: #ffffff;
  }

  input {
    width: 100%;
    padding: 10px;
    margin-top: 5px;
    margin-bottom: 15px;
    border: 1px solid #3a506b;
    border-radius: 4px;
    font-size: 16px;
    background-color: #d4f8e8; /* Verde muy clarito */
    color: #0a1128; /* Azul oscuro para el texto */
  }

  input::placeholder {
    color: #6c757d; /* Color gris para el texto del placeholder */
  }

  input:focus {
    outline: none;
    border-color: #25d366; /* Verde de WhatsApp al enfocar */
    box-shadow: 0 0 5px #25d366;
  }

  button {
    display: inline-block;
    padding: 10px 20px;
    margin: 10px auto; /* Centra los botones verticalmente */
    font-size: 16px;
    font-weight: bold;
    color: #0a1128; /* Azul oscuro para el texto */
    background-color: #25d366; /* Verde de WhatsApp */
    border: none;
    border-radius: 4px;
    cursor: pointer;
    transition: background-color 0.3s ease, transform 0.2s ease;
    display: block; /* Asegura que los botones ocupen toda la línea */
    text-align: center; /* Centra el texto dentro del botón */
  }

  button:hover {
    background-color: #1da851; /* Verde más oscuro al pasar el mouse */
    transform: scale(1.05);
  }

  button:active {
    transform: scale(0.95);
  }

  form button {
    width: 100%; /* Hace que los botones ocupen todo el ancho del formulario */
    max-width: 300px; /* Limita el ancho máximo de los botones */
  }

  .output {
    margin-top: 20px;
    padding: 10px;
    background-color: #1c2541; /* Azul más claro */
    border: 1px solid #3a506b;
    border-radius: 4px;
    text-align: center;
    color: #ffffff;
  }

  .output a {
    color: #4fc3f7; /* Azul brillante para los links */
    text-decoration: none;
    font-weight: bold;
  }

  .output a:hover {
    text-decoration: underline;
  }

  .numero-container {
    display: flex;
    align-items: center;
    margin-bottom: 10px;
  }

  .bandera-container {
    margin-right: 10px;
  }

  .bandera {
    width: 24px;
    height: 16px;
  }

  .numero {
    flex: 1;
    padding: 10px;
    border: 1px solid #3a506b;
    border-radius: 4px;
    font-size: 16px;
    background-color: #d4f8e8; /* Verde muy clarito */
    color: #0a1128; /* Azul oscuro para el texto */
  }

  .numero::placeholder {
    color: #6c757d; /* Color gris para el texto del placeholder */
  }

  .numero:focus {
    outline: none;
    border-color: #25d366; /* Verde de WhatsApp al enfocar */
    box-shadow: 0 0 5px #25d366;
  }

  .info-container {
    max-width: 800px;
    margin: 40px auto;
    padding: 20px;
    background-color: #1c2541; /* Azul más claro */
    border-radius: 8px;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    color: #ffffff;
    text-align: left;
  }

  .info-title {
    text-align: center;
    color: #25d366; /* Verde de WhatsApp */
    font-size: 1.8rem;
    margin-bottom: 20px;
  }

  .info-container p {
    font-size: 1rem;
    line-height: 1.6;
    margin-bottom: 20px;
  }

  .info-container ul {
    list-style-type: disc;
    margin-left: 20px;
    margin-bottom: 20px;
  }

  .info-container ul li {
    margin-bottom: 10px;
  }

  #probar-multilink-container {
    margin-top: 50px; /* Aumenta la separación del título respecto al botón de iniciar sesión */
  }

  #probar-multilink-container h1 {
    font-size: 1.6rem; /* Tamaño de fuente más pequeño */
  }

  .detalles-link {
    margin-top: 20px;
    padding: 10px;
    background-color: #1c2541; /* Azul más claro */
    border: 1px solid #3a506b;
    border-radius: 4px;
    color: #ffffff;
  }

  .detalles-link h3 {
    margin-top: 0;
    color: #25d366; /* Verde de WhatsApp */
  }

  #editar-link-container {
    margin-top: 20px;
    padding: 10px;
    background-color: #1c2541; /* Azul más claro */
    border: 1px solid #3a506b;
    border-radius: 4px;
    color: #ffffff;
  }

  #editar-link-container h3 {
    margin-top: 0;
    color: #25d366; /* Verde de WhatsApp */
  }

  .numero-item {
    display: flex;
    align-items: center;
    margin-bottom: 10px;
  }

  .numero-item label {
    margin-right: 10px;
    font-weight: bold;
  }

  .numero-item input {
    flex: 1;
    padding: 5px;
    border: 1px solid #3a506b;
    border-radius: 4px;
    font-size: 14px;
    background-color: #d4f8e8; /* Verde muy clarito */
    color: #0a1128; /* Azul oscuro */
  }

  #acortar-link-container {
    display: none;
    margin-top: 20px;
  }

  #acortar-link-container h3 {
    color: #25d366; /* Verde de WhatsApp */
  }
  </style>
</head>
<body>
  <header>
    <h1 class="titulo-principal">MultiLink</h1>
  </header>

  <!-- Contenedor de inicio de sesión -->
  <div id="login-container" class="active">
    <h2>Iniciar sesión</h2>
    <label for="email">Correo electrónico:</label>
    <input type="email" id="email" placeholder="Correo electrónico" required>
    <label for="password">Contraseña:</label>
    <input type="password" id="password" placeholder="Contraseña" required>
    <button onclick="login()">Iniciar sesión</button>
    <p id="login-error" style="color: red;"></p>
  </div>

  <!-- Contenedor principal del generador -->
  <div id="generador-container" style="display: none;">
    <h1>Generador de Links Multiagente</h1>
    <form id="form">
      <div id="numeros-container">
        <div class="numero-container" id="numero-container-1">
          <span class="bandera-container">
            <img src="https://flagcdn.com/w40/ar.png" alt="Argentina" class="bandera">
          </span>
          <input type="text" id="numero-1" class="numero" value="+549" placeholder="Ejemplo: 2944585356">
        </div>
      </div>
      <button type="button" onclick="agregarNumero()">Agregar otro número</button>
      <button type="button" onclick="quitarUltimoNumero()">Quitar último número</button>

      <!-- Campo de mensaje automático en el generador principal -->
      <label for="mensaje">Mensaje automático:</label>
      <input type="text" id="mensaje" placeholder="Ejemplo: Hola, necesito ayuda">

      <button type="button" onclick="generarLink()">Generar Link</button>
    </form>

    <div class="output" id="output"></div>
    <div class="detalles-link" id="detalles-link" style="display: none;">
      <h3>Detalles del Link Generado:</h3>
      <p><strong>Números:</strong> <span id="numeros-generados"></span></p>
      <p><strong>Mensaje Automático:</strong> <span id="mensaje-generado"></span></p>
    </div>
    
  </div>

  

  <!-- Contenedor para editar link -->
  <div id="editar-link-container" style="display: none;">
    <h3>Editar Link</h3>
    <div id="editar-numeros-container"></div>
    <label for="editar-mensaje">Mensaje Automático:</label>
    <input type="text" id="editar-mensaje" placeholder="Ejemplo: Hola, necesito ayuda">
    <button onclick="actualizarLink()">Actualizar Link</button>
  </div>

  <!-- Contenedor para acortar link manualmente -->
  <div id="acortar-link-container" style="display: none; margin-top: 20px;">
    <h3>Acortar Link</h3>
    <form id="acortar-link-form">
      <label for="link-original">Ingresa un link para acortar:</label>
      <input type="text" id="link-original" placeholder="Ejemplo: https://www.ejemplo.com" />
      <button type="button" onclick="acortarLinkManual()">Acortar Link</button>
    </form>
    <div id="acortar-link-output" class="output"></div>
  </div>

  <div class="info-container">
    <h2 class="info-title">¿Para qué sirve MultiLink?</h2>
    <p>MultiLink es una herramienta diseñada especialmente para creadores de contenido, emprendedores y vendedores que utilizan WhatsApp como canal principal de ventas o atención.</p>
    <ul>
      <li>Evitar bloqueos por exceso de mensajes en una sola línea</li>
      <li>Distribuir el flujo de clientes entre diferentes operadores</li>
      <li>Atender más rápido y de forma organizada</li>
      <li>Adaptarse al crecimiento de tu negocio sin complicaciones</li>
    </ul>
    <p>Ya sea que vendas por WhatsApp, Telegram, redes sociales o tiendas online, MultiLink te ayuda a optimizar tu atención al cliente y aumentar tus conversiones.</p>
  </div>

<script>
  let contadorNumeros = 1;
  let limiteNumeros = 0;

  function agregarNumero() {
    if (contadorNumeros >= limiteNumeros) {
      alert(`Solo puedes agregar hasta ${limiteNumeros} números.`);
      document.querySelector('button[onclick="agregarNumero()"]').disabled = true;
      return;
    }

    contadorNumeros++;
    const container = document.getElementById('numeros-container');
    const nuevoCampo = document.createElement('div');
    nuevoCampo.classList.add('numero-container');
    nuevoCampo.id = `numero-container-${contadorNumeros}`;
    nuevoCampo.innerHTML = `
      <span class="bandera-container">
        <img src="https://flagcdn.com/w40/ar.png" alt="Argentina" class="bandera">
      </span>
      <input type="text" id="numero-${contadorNumeros}" class="numero" value="+549" placeholder="Ejemplo: 2944585356">
    `;
    container.appendChild(nuevoCampo);

    if (contadorNumeros >= limiteNumeros) {
      document.querySelector('button[onclick="agregarNumero()"]').disabled = true;
    }
  }

  function quitarUltimoNumero() {
    if (contadorNumeros > 1) {
      const container = document.getElementById('numeros-container');
      const ultimoCampo = document.getElementById(`numero-container-${contadorNumeros}`);
      if (ultimoCampo) {
        container.removeChild(ultimoCampo);
        contadorNumeros--;
        document.querySelector('button[onclick="agregarNumero()"]').disabled = false;
      }
    } else {
      alert('Debe haber al menos un número.');
    }
  }

  async function login() {
    const email = document.getElementById('email').value.trim();
    const password = document.getElementById('password').value.trim();

    if (!email || !password) {
      document.getElementById('login-error').textContent = 'Por favor, ingresa tu correo y contraseña.';
      return;
    }

    try {
      const response = await fetch(`/soporte?email=${encodeURIComponent(email)}&password=${encodeURIComponent(password)}`);
      const data = await response.json();

      if (response.ok) {
        // Oculta el contenedor de inicio de sesión
        document.getElementById('login-container').style.display = 'none';

        // Muestra el generador principal
        document.getElementById('generador-container').style.display = 'block';

        // Configura el límite de números
        limiteNumeros = data.limiteNumeros;

        // Guarda el correo del usuario en localStorage
        localStorage.setItem('usuarioEmail', email);

        // Recupera los datos del usuario actual desde localStorage
        const linkGuardado = localStorage.getItem(`linkGenerado_${email}`);
        const numerosGuardados = JSON.parse(localStorage.getItem(`numerosGenerados_${email}`)) || [];
        const mensajeGuardado = localStorage.getItem(`mensajeGenerado_${email}`) || '';

        if (linkGuardado) {
          // Mostrar los detalles del link
          document.getElementById('detalles-link').style.display = 'block';
          document.getElementById('numeros-generados').textContent = numerosGuardados.join(', ');
          document.getElementById('mensaje-generado').textContent = mensajeGuardado || 'Sin mensaje';

          // Mostrar el link guardado
          document.getElementById('output').innerHTML = `
            <p>Tu link generado:</p>
            <a href="${linkGuardado}" target="_blank">${linkGuardado}</a>
          `;

          // Mostrar el apartado "Editar Link"
          document.getElementById('editar-link-container').style.display = 'block';
          mostrarEditarLink(numerosGuardados);
        } else {
          // Ocultar las secciones si no hay datos
          document.getElementById('detalles-link').style.display = 'none';
          document.getElementById('editar-link-container').style.display = 'none';
        }
      } else {
        document.getElementById('login-error').textContent = data.error;
      }
    } catch (error) {
      console.error('Error al iniciar sesión:', error);
      document.getElementById('login-error').textContent = 'Error al iniciar sesión.';
    }
  }

  async function generarLink() {
    const email = localStorage.getItem('usuarioEmail');

    if (!email) {
      alert('Por favor, inicia sesión antes de generar un link.');
      return;
    }

    // Verificar si ya existe un link generado para este usuario
    const linkGuardado = localStorage.getItem(`linkGenerado_${email}`);
    if (linkGuardado) {
      alert('Ya tienes un link generado. Solo puedes actualizarlo.');
      return;
    }

    const numeros = Array.from(document.querySelectorAll('.numero'))
      .map(input => input.value.trim())
      .filter(num => num !== '');

    const mensaje = document.getElementById('mensaje').value.trim();

    if (numeros.length === 0) {
      alert('Por favor, ingresa al menos un número válido.');
      return;
    }

    try {
      const response = await fetch('/soporte', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email, numeros, mensaje }),
      });

      const data = await response.json();

      if (response.ok) {
        const link = data.link;
        const id = data.id;

        // Guardar datos en localStorage
        localStorage.setItem(`linkGenerado_${email}`, link);
        localStorage.setItem(`linkID_${email}`, id);
        localStorage.setItem(`numerosGenerados_${email}`, JSON.stringify(numeros));
        localStorage.setItem(`mensajeGenerado_${email}`, mensaje);

        // Mostrar el link generado
        document.getElementById('output').innerHTML = `
          <p>Tu link generado:</p>
          <a href="${link}" target="_blank">${link}</a>
        `;

        // Mostrar los detalles del link
        document.getElementById('detalles-link').style.display = 'block';
        document.getElementById('numeros-generados').textContent = numeros.join(', ');
        document.getElementById('mensaje-generado').textContent = mensaje || 'Sin mensaje';

        // Mostrar el apartado "Editar Link"
        document.getElementById('editar-link-container').style.display = 'block';
        mostrarEditarLink(numeros);
      } else {
        alert('Error: ' + data.error);
      }
    } catch (error) {
      console.error('Error generando link:', error);
    }
  }

  

  

 
  function reiniciarGenerador() {
    // Reiniciar el contador de números
    contadorNumeros = 1;
    document.getElementById('mensaje').value = ''; // Limpiar el campo de mensaje

    // Limpiar los números generados
    const numerosInputs = document.querySelectorAll('.numero');
    numerosInputs.forEach((input, index) => {
      if (index === 0) {
        input.value = '+549'; // Restablecer el primer número a su valor por defecto
      } else {
        input.value = ''; // Limpiar los demás campos de número
      }
    });

    // Limpiar el output
    document.getElementById('output').innerHTML = '';

    // Ocultar detalles del link
    document.getElementById('detalles-link').style.display = 'none';

    // Habilitar el botón de generación
    document.querySelector('button[onclick="generarLink()"]').disabled = false;
  }

  function mostrarEditarLink(numeros) {
    const editarNumerosContainer = document.getElementById('editar-numeros-container');
    editarNumerosContainer.innerHTML = '';

    for (let i = 0; i < limiteNumeros; i++) {
      const numero = numeros[i] || ''; // Si no hay un número en esa posición, deja el campo vacío
      const numeroItem = document.createElement('div');
      numeroItem.classList.add('numero-item');
      numeroItem.innerHTML = `
        <label for="editar-numero-${i}">Número ${i + 1}:</label>
        <input type="text" id="editar-numero-${i}" value="${numero}" placeholder="Ejemplo: +5492944585356" />
      `;
      editarNumerosContainer.appendChild(numeroItem);
    }
  }

  async function actualizarLink() {
    const email = localStorage.getItem('usuarioEmail');
    const id = localStorage.getItem(`linkID_${email}`);
    const linkGenerado = localStorage.getItem(`linkGenerado_${email}`);

    if (!email || !id || !linkGenerado) {
      alert('No se encontró un link asociado a este perfil. Por favor, genera un link primero.');
      return;
    }

    const numeros = Array.from(document.querySelectorAll('#editar-numeros-container input'))
      .map(input => input.value.trim())
      .filter(num => num !== ''); // Filtra los campos vacíos

    const mensaje = document.getElementById('editar-mensaje').value.trim(); // Captura el mensaje actualizado

    if (numeros.length === 0) {
      alert('Por favor, ingresa al menos un número válido.');
      return;
    }

    try {
      const response = await fetch('/soporte', {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email, numeros, mensaje }),
      });

      const data = await response.json();

      if (response.ok) {
        alert('Link actualizado correctamente.');

        // Actualiza los detalles del link en el DOM
        document.getElementById('numeros-generados').textContent = numeros.join(', ');
        document.getElementById('mensaje-generado').textContent = mensaje || 'Sin mensaje';

        // Guarda los números y el mensaje actualizados en localStorage
        localStorage.setItem(`numerosGenerados_${email}`, JSON.stringify(numeros));
        localStorage.setItem(`mensajeGenerado_${email}`, mensaje);
      } else {
        alert('Error: ' + data.error);
      }
    } catch (error) {
      console.error('Error actualizando el link:', error);
    }
  }

  async function acortarLinkManual() {
    const linkOriginal = document.getElementById('link-original').value.trim();

    if (!linkOriginal) {
      alert('Por favor, ingresa un link para acortar.');
      return;
    }

    try {
      const response = await fetch('/acortar', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ link: linkOriginal })
      });

      const data = await response.json();

      if (response.ok) {
        document.getElementById('acortar-link-output').innerHTML = `
          <p>Link acortado con éxito:</p>
          <a href="${data.link}" target="_blank">${data.link}</a>
        `;
      } else {
        alert('Error: ' + data.error);
      }
    } catch (error) {
      console.error('Error al acortar el link:', error);
    }
  }

  document.addEventListener('DOMContentLoaded', () => {
  const email = localStorage.getItem('usuarioEmail'); // Correo del usuario logueado

  if (!email) {
    // Si no hay un usuario logueado, oculta las secciones
    document.getElementById('detalles-link').style.display = 'none';
    document.getElementById('editar-link-container').style.display = 'none';
    return;
  }

  // Recupera los datos del usuario actual desde localStorage
  const linkGuardado = localStorage.getItem(`linkGenerado_${email}`);
  const numerosGuardados = JSON.parse(localStorage.getItem(`numerosGenerados_${email}`)) || [];
  const mensajeGuardado = localStorage.getItem(`mensajeGenerado_${email}`) || '';

  if (linkGuardado) {
    // Mostrar los detalles del link
    document.getElementById('detalles-link').style.display = 'block';
    document.getElementById('numeros-generados').textContent = numerosGuardados.join(', ');
    document.getElementById('mensaje-generado').textContent = mensajeGuardado || 'Sin mensaje';

    // Mostrar el link guardado
    document.getElementById('output').innerHTML = `
      <p>Tu link generado:</p>
      <a href="${linkGuardado}" target="_blank">${linkGuardado}</a>
    `;

    // Mostrar el apartado "Editar Link"
    document.getElementById('editar-link-container').style.display = 'block';
    mostrarEditarLink(numerosGuardados);
  } else {
    // Ocultar las secciones si no hay datos
    document.getElementById('detalles-link').style.display = 'none';
    document.getElementById('editar-link-container').style.display = 'none';
  }
});


  async function login() {
    const email = document.getElementById('email').value.trim();
    const password = document.getElementById('password').value.trim();

    if (!email || !password) {
      document.getElementById('login-error').textContent = 'Por favor, ingresa tu correo y contraseña.';
      return;
    }

    try {
      const response = await fetch(`/soporte?email=${encodeURIComponent(email)}&password=${encodeURIComponent(password)}`);
      const data = await response.json();

      if (response.ok) {
        // Oculta el contenedor de inicio de sesión
        document.getElementById('login-container').style.display = 'none';

        // Muestra el generador principal
        document.getElementById('generador-container').style.display = 'block';

        // Configura el límite de números
        limiteNumeros = data.limiteNumeros;

        // Guarda el correo del usuario en localStorage
        localStorage.setItem('usuarioEmail', email);

        // Recupera los datos del usuario actual desde localStorage
        const linkGuardado = localStorage.getItem(`linkGenerado_${email}`);
        const numerosGuardados = JSON.parse(localStorage.getItem(`numerosGenerados_${email}`)) || [];
        const mensajeGuardado = localStorage.getItem(`mensajeGenerado_${email}`) || '';

        if (linkGuardado) {
          // Mostrar los detalles del link
          document.getElementById('detalles-link').style.display = 'block';
          document.getElementById('numeros-generados').textContent = numerosGuardados.join(', ');
          document.getElementById('mensaje-generado').textContent = mensajeGuardado || 'Sin mensaje';

          // Mostrar el link guardado
          document.getElementById('output').innerHTML = `
            <p>Tu link generado:</p>
            <a href="${linkGuardado}" target="_blank">${linkGuardado}</a>
          `;

          // Mostrar el apartado "Editar Link"
          document.getElementById('editar-link-container').style.display = 'block';
          mostrarEditarLink(numerosGuardados);
        } else {
          // Ocultar las secciones si no hay datos
          document.getElementById('detalles-link').style.display = 'none';
          document.getElementById('editar-link-container').style.display = 'none';
        }
      } else {
        document.getElementById('login-error').textContent = data.error;
      }
    } catch (error) {
      console.error('Error al iniciar sesión:', error);
      document.getElementById('login-error').textContent = 'Error al iniciar sesión.';
    }
  }
</script>
</body>
</html>