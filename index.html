<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Generador de Links Multiagente</title>
  <link rel="stylesheet" href="styles.css"> <!-- Si el nuevo diseño incluye un archivo CSS -->
</head>
<body>
  <!-- Nuevo diseño del archivo `index(3)` -->
  <header>
    <h1 class="titulo-principal">MultiLink</h1>
  </header>

  <!-- Contenedor de inicio de sesión -->
  <div id="login-container" class="active">
    <h2>Iniciar sesión</h2>
    <label for="email">Correo electrónico:</label>
    <input type="email" id="email" placeholder="Correo electrónico" required>
    <label for="password">Contraseña:</label>
    <input type="password" id="password" placeholder="Contraseña" required>
    <button onclick="login()">Iniciar sesión</button>
    <p id="login-error" style="color: red;"></p>
  </div>

  <!-- Contenedor principal del generador -->
  <div id="generador-container" style="display: none;">
    <h1>Generador de Links Multiagente</h1>
    <form id="form">
      <div id="numeros-container">
        <div class="numero-container" id="numero-container-1">
          <span class="bandera-container">
            <img src="https://flagcdn.com/w40/ar.png" alt="Argentina" class="bandera">
          </span>
          <input type="text" id="numero-1" class="numero" value="+549" placeholder="Ejemplo: 2944585356">
        </div>
      </div>
      <button type="button" onclick="agregarNumero()">Agregar otro número</button>
      <button type="button" onclick="quitarUltimoNumero()">Quitar último número</button>

      <!-- Campo de mensaje automático en el generador principal -->
      <label for="mensaje">Mensaje automático:</label>
      <input type="text" id="mensaje" placeholder="Ejemplo: Hola, necesito ayuda">

      <button type="button" onclick="generarLink()">Generar Link</button>
    </form>

    <div class="output" id="output"></div>
    <div class="detalles-link" id="detalles-link" style="display: none;">
      <h3>Detalles del Link Generado:</h3>
      <p><strong>Números:</strong> <span id="numeros-generados"></span></p>
      <p><strong>Mensaje Automático:</strong> <span id="mensaje-generado"></span></p>
    </div>
  </div>

  <!-- Contenedor para editar link -->
  <div id="editar-link-container" style="display: none;">
    <h3>Editar Link</h3>
    <div id="editar-numeros-container"></div>
    <label for="editar-mensaje">Mensaje Automático:</label>
    <input type="text" id="editar-mensaje" placeholder="Ejemplo: Hola, necesito ayuda">
    <button onclick="actualizarLink()">Actualizar Link</button>
  </div>

  <!-- Contenedor para acortar link manualmente -->
  <div id="acortar-link-container" style="display: none; margin-top: 20px;">
    <h3>Acortar Link</h3>
    <form id="acortar-link-form">
      <label for="link-original">Ingresa un link para acortar:</label>
      <input type="text" id="link-original" placeholder="Ejemplo: https://www.ejemplo.com" />
      <button type="button" onclick="acortarLinkManual()">Acortar Link</button>
    </form>
    <div id="acortar-link-output" class="output"></div>
  </div>

  <div class="info-container">
    <h2 class="info-title">¿Para qué sirve MultiLink?</h2>
    <p>MultiLink es una herramienta diseñada especialmente para creadores de contenido, emprendedores y vendedores que utilizan WhatsApp como canal principal de ventas o atención.</p>
    <ul>
      <li>Evitar bloqueos por exceso de mensajes en una sola línea</li>
      <li>Distribuir el flujo de clientes entre diferentes operadores</li>
      <li>Atender más rápido y de forma organizada</li>
      <li>Adaptarse al crecimiento de tu negocio sin complicaciones</li>
    </ul>
    <p>Ya sea que vendas por WhatsApp, Telegram, redes sociales o tiendas online, MultiLink te ayuda a optimizar tu atención al cliente y aumentar tus conversiones.</p>
  </div>

  <!-- Scripts con las funcionalidades existentes -->
  <script>
    let contadorNumeros = 1;
    let limiteNumeros = 0;

    function agregarNumero() {
      if (contadorNumeros >= limiteNumeros) {
        alert(`Solo puedes agregar hasta ${limiteNumeros} números.`);
        document.querySelector('button[onclick="agregarNumero()"]').disabled = true;
        return;
      }

      contadorNumeros++;
      const container = document.getElementById('numeros-container');
      const nuevoCampo = document.createElement('div');
      nuevoCampo.classList.add('numero-container');
      nuevoCampo.id = `numero-container-${contadorNumeros}`;
      nuevoCampo.innerHTML = `
        <span class="bandera-container">
          <img src="https://flagcdn.com/w40/ar.png" alt="Argentina" class="bandera">
        </span>
        <input type="text" id="numero-${contadorNumeros}" class="numero" value="+549" placeholder="Ejemplo: 2944585356">
      `;
      container.appendChild(nuevoCampo);

      if (contadorNumeros >= limiteNumeros) {
        document.querySelector('button[onclick="agregarNumero()"]').disabled = true;
      }
    }

    function quitarUltimoNumero() {
      if (contadorNumeros > 1) {
        const container = document.getElementById('numeros-container');
        const ultimoCampo = document.getElementById(`numero-container-${contadorNumeros}`);
        if (ultimoCampo) {
          container.removeChild(ultimoCampo);
          contadorNumeros--;
          document.querySelector('button[onclick="agregarNumero()"]').disabled = false;
        }
      } else {
        alert('Debe haber al menos un número.');
      }
    }

    async function login() {
      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value.trim();

      if (!email || !password) {
        document.getElementById('login-error').textContent = 'Por favor, ingresa tu correo y contraseña.';
        return;
      }

      try {
        const response = await fetch('/api/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password }),
        });

        const data = await response.json();

        if (response.ok) {
          // Oculta el contenedor de inicio de sesión
          document.getElementById('login-container').style.display = 'none';

          // Muestra el generador principal
          document.getElementById('generador-container').style.display = 'block';

          // Configura el límite de números
          limiteNumeros = data.limiteNumeros;

          // Guarda el correo del usuario en localStorage
          localStorage.setItem('usuarioEmail', email);

          // Mostrar los detalles del link y el apartado "Editar Link"
          mostrarDetallesLink();
        } else {
          document.getElementById('login-error').textContent = data.error;
        }
      } catch (error) {
        console.error('Error al iniciar sesión:', error);
        document.getElementById('login-error').textContent = 'Error al iniciar sesión.';
      }
    }

    async function generarLink() {
      const numeros = Array.from(document.querySelectorAll('.numero'))
        .map(input => input.value.trim())
        .filter(num => num !== '');

      const mensaje = document.getElementById('mensaje').value.trim();
      const email = localStorage.getItem('usuarioEmail'); // Recupera el email del usuario logueado

      if (!email) {
        alert('Por favor, inicia sesión antes de generar un link.');
        return;
      }

      if (numeros.length === 0) {
        alert('Por favor, ingresa al menos un número válido.');
        return;
      }

      try {
        const response = await fetch('/api/soporte', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, numeros, mensaje }),
        });

        const data = await response.json();

        if (response.ok) {
          // Muestra el link acortado en el DOM
          document.getElementById('output').innerHTML = `
            <p>Tu link generado:</p>
            <a href="${data.link}" target="_blank">${data.link}</a>
          `;

          // Guarda los datos en localStorage
          localStorage.setItem(`linkGenerado_${email}`, data.link);
          localStorage.setItem(`numerosGenerados_${email}`, JSON.stringify(numeros));
          localStorage.setItem(`mensajeGenerado_${email}`, mensaje);
          localStorage.setItem(`linkID_${email}`, data.id); // Guarda el ID del link

          // Mostrar el apartado "Editar Link"
          document.getElementById('editar-link-container').style.display = 'block';
          mostrarEditarLink(numeros);
        } else {
          alert('Error: ' + data.error);
        }
      } catch (error) {
        console.error('Error generando link:', error);
        document.getElementById('output').innerHTML = `<p>Error al generar el link. Inténtalo de nuevo.</p>`;
      }
    }

    async function generarLinkPrueba() {
      const numero = document.getElementById('numero-prueba').value.trim();
      const mensaje = document.getElementById('mensaje-prueba').value.trim(); // Permitir mensaje vacío
      const email = "prueba@multi.link";

      if (!numero) {
        alert('Por favor, ingresa un número.');
        return;
      }

      try {
        const response = await fetch('/soporte', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ numeros: [numero], mensaje, email })
        });

        const data = await response.json();

        if (response.ok) {
          const shortUrl = `${location.origin}/soporte?id=${data.id}`;
          document.getElementById('output-prueba').innerHTML = `
            <p>Tu link de prueba generado:</p>
            <a href="${shortUrl}" target="_blank">${shortUrl}</a>
          `;
        } else {
          alert('Error: ' + data.error);
        }
      } catch (error) {
        console.error('Error generando link de prueba:', error);
      }
    }

    function probarMultiLink() {
      document.getElementById('login-container').classList.remove('active');
      document.getElementById('probar-multilink-container').classList.add('active');
      document.getElementById('numero-prueba').value = '';
      document.getElementById('mensaje-prueba').value = '';
    }

    function volverAlLogin() {
      document.getElementById('probar-multilink-container').classList.remove('active');
      document.getElementById('login-container').classList.add('active');
    }

    function reiniciarGenerador() {
      // Reiniciar el contador de números
      contadorNumeros = 1;
      document.getElementById('mensaje').value = ''; // Limpiar el campo de mensaje

      // Limpiar los números generados
      const numerosInputs = document.querySelectorAll('.numero');
      numerosInputs.forEach((input, index) => {
        if (index === 0) {
          input.value = '+549'; // Restablecer el primer número a su valor por defecto
        } else {
          input.value = ''; // Limpiar los demás campos de número
        }
      });

      // Limpiar el output
      document.getElementById('output').innerHTML = '';

      // Ocultar detalles del link
      document.getElementById('detalles-link').style.display = 'none';

      // Habilitar el botón de generación
      document.querySelector('button[onclick="generarLink()"]').disabled = false;
    }

    function mostrarEditarLink(numeros) {
      const editarNumerosContainer = document.getElementById('editar-numeros-container');
      editarNumerosContainer.innerHTML = '';

      numeros.forEach((numero, index) => {
        const numeroItem = document.createElement('div');
        numeroItem.classList.add('numero-item');
        numeroItem.innerHTML = `
          <label for="editar-numero-${index}">Número ${index + 1}:</label>
          <input type="text" id="editar-numero-${index}" value="${numero}" placeholder="Ejemplo: +5492944585356" />
        `;
        editarNumerosContainer.appendChild(numeroItem);
      });
    }

    async function actualizarLink() {
      const numeros = Array.from(document.querySelectorAll('#editar-numeros-container input'))
        .map(input => input.value.trim())
        .filter(num => num !== '');

      const mensaje = document.getElementById('editar-mensaje').value.trim();
      const email = localStorage.getItem('usuarioEmail');
      const id = localStorage.getItem(`linkID_${email}`);

      if (!email || !id) {
        alert('No se encontró un usuario o ID guardado. Por favor, inicia sesión y genera un link primero.');
        return;
      }

      if (numeros.length === 0) {
        alert('Por favor, ingresa al menos un número válido.');
        return;
      }

      try {
        const response = await fetch('/api/soporte', {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, numeros, mensaje, id }),
        });

        const data = await response.json();

        if (response.ok) {
          alert('Link actualizado correctamente.');

          document.getElementById('numeros-generados').textContent = numeros.join(', ');
          document.getElementById('mensaje-generado').textContent = mensaje || 'Sin mensaje';
        } else {
          alert('Error: ' + data.error);
        }
      } catch (error) {
        console.error('Error actualizando el link:', error);
        alert('Error al actualizar el link. Inténtalo de nuevo.');
      }
    }

    async function acortarLinkManual() {
      const linkOriginal = document.getElementById('link-original').value.trim();

      if (!linkOriginal) {
        alert('Por favor, ingresa un link para acortar.');
        return;
      }

      try {
        const response = await fetch('/acortar', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ link: linkOriginal })
        });

        const data = await response.json();

        if (response.ok) {
          document.getElementById('acortar-link-output').innerHTML = `
            <p>Link acortado con éxito:</p>
            <a href="${data.link}" target="_blank">${data.link}</a>
          `;
        } else {
          alert('Error: ' + data.error);
        }
      } catch (error) {
        console.error('Error al acortar el link:', error);
      }
    }

    async function obtenerLinkUsuario() {
      const email = localStorage.getItem('usuarioEmail'); // Recupera el email del usuario logueado

      if (!email) {
        console.error('No hay un usuario logueado.');
        return null;
      }

      try {
        const response = await fetch(`/api/soporte?email=${encodeURIComponent(email)}`, {
          method: 'GET', // Método GET para consultar el backend
          headers: { 'Content-Type': 'application/json' },
        });

        if (!response.ok) {
          console.error('Error al obtener el link del usuario:', await response.text());
          return null;
        }

        const data = await response.json();
        return data; // Devuelve el registro del link del usuario
      } catch (error) {
        console.error('Error al consultar el backend:', error);
        return null;
      }
    }

    async function mostrarDetallesLink() {
      const linkData = await obtenerLinkUsuario(); // Consulta el link del usuario

      if (linkData) {
        // Mostrar los detalles del link en el contenedor #detalles-link
        document.getElementById('detalles-link').style.display = 'block';
        document.getElementById('output').innerHTML = `
          <p>Tu link generado:</p>
          <a href="${linkData.link}" target="_blank">${linkData.link}</a>
        `;
        document.getElementById('numeros-generados').textContent = linkData.numeros.join(', ');
        document.getElementById('mensaje-generado').textContent = linkData.mensaje || 'Sin mensaje';

        // Mostrar el apartado "Editar Link"
        document.getElementById('editar-link-container').style.display = 'block';
        mostrarEditarLink(linkData.numeros); // Inicializa los campos de edición con los números actuales
        document.getElementById('editar-mensaje').value = linkData.mensaje || ''; // Inicializa el mensaje en el campo de edición
      } else {
        // Ocultar el contenedor si no hay datos
        document.getElementById('detalles-link').style.display = 'none';
        document.getElementById('editar-link-container').style.display = 'none';
      }
    }

    // Llama a esta función al cargar la página
    document.addEventListener('DOMContentLoaded', () => {
      mostrarDetallesLink();
    });
  </script>
</body>
</html>